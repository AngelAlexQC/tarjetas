# Workflow reutilizable para generaci√≥n de PDF desde SonarCloud
name: Reusable PDF Report Generator

on:
  workflow_call:
    inputs:
      project-version:
        description: 'Project version for the report'
        required: false
        type: string
        default: '1.0.0'
      artifact-retention-days:
        description: 'Days to retain artifacts'
        required: false
        type: number
        default: 30
    secrets:
      SONAR_TOKEN:
        required: true
      AZURE_DEVOPS_TOKEN:
        required: true
  workflow_dispatch:
    inputs:
      project-version:
        description: 'Project version for the report'
        required: false
        type: string
        default: '1.0.0'
      artifact-retention-days:
        description: 'Days to retain artifacts'
        required: false
        type: number
        default: 30

jobs:
  generate:
    name: Generate PDF Report
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/puppeteer/puppeteer:latest
      options: --user root # Needed to write to the mounted workspace and install packages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install dependencies for PDF generation
        run: npm install puppeteer axios

      - name: Wait for SonarCloud to process analysis
        run: sleep 30

      - name: Generate PDF Report
        env:
          SONAR_URL: https://sonarcloud.io
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: AngelAlexQC_tarjetas
          SONAR_PROJECT_NAME: LibelulaSoft Tarjetas
          SONAR_PROJECT_VERSION: ${{ inputs.project-version }}
          OUTPUT_DIR: ${{ github.workspace }}/output
        run: |
          mkdir -p output
          node scripts/generate-professional-sonar-report.js

      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-quality-report-pdf
          path: output/sonar-professional-report.pdf
          retention-days: ${{ inputs.artifact-retention-days }}

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-quality-report-html
          path: output/sonar-professional-report.html
          retention-days: ${{ inputs.artifact-retention-days }}
