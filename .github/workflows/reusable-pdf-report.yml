# Workflow reutilizable para generaci√≥n de PDF desde SonarCloud
name: Reusable PDF Report Generator

on:
  workflow_call:
    inputs:
      project-version:
        description: 'Project version for the report'
        required: false
        type: string
        default: '1.0.0'
      artifact-retention-days:
        description: 'Days to retain artifacts'
        required: false
        type: number
        default: 30
    secrets:
      SONAR_TOKEN:
        required: true
      AZURE_DEVOPS_TOKEN:
        required: true
  workflow_dispatch:
    inputs:
      project-version:
        description: 'Project version for the report'
        required: false
        type: string
        default: '1.0.0'
      artifact-retention-days:
        description: 'Days to retain artifacts'
        required: false
        type: number
        default: 30

jobs:
  generate:
    name: Generate PDF Report
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/puppeteer/puppeteer:latest
      options: --user root # Needed to write to the mounted workspace and install packages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install dependencies for PDF generation
        run: npm install puppeteer axios

      - name: Wait for SonarCloud to process analysis
        run: sleep 30

      - name: Generate PDF Report
        env:
          SONAR_URL: https://sonarcloud.io
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: AngelAlexQC_tarjetas
          SONAR_PROJECT_NAME: LibelulaSoft Tarjetas
          SONAR_PROJECT_VERSION: ${{ inputs.project-version }}
          OUTPUT_DIR: ${{ github.workspace }}/output
        run: |
          mkdir -p output
          node scripts/generate-professional-sonar-report.js

      - name: Push Report to Azure DevOps
        if: success()
        run: |
          # Install git if missing (container might strictly be minimal)
          which git || (apt-get update && apt-get install -y git)
          
          # Configure Git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Clone Azure DevOps Repo
          echo "Cloning Azure DevOps repository..."
          # Mask token in logs just in case, though secrets are masked automatically
          git clone https://${{ secrets.AZURE_DEVOPS_TOKEN }}@dev.azure.com/LibelulaSoft/Orion/_git/OrionCards azure_repo
          
          # Copy PDF to root
          echo "Copying PDF report..."
          cp output/*.pdf azure_repo/
          
          # Commit and Push
          cd azure_repo
          git add *.pdf
          git commit -m "chore: upload SonarCloud PDF report [skip ci]" || echo "No changes to commit"
          git push
          # Note: Assuming default branch is 'master' or 'main'. If unsure, we can check. 
          # But 'HEAD:master' force pushes to master? No, standard push. 
          # Safer to just git push and let it push to the cloned branch (usually default).

      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-quality-report-pdf
          path: output/*.pdf
          retention-days: ${{ inputs.artifact-retention-days }}

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-quality-report-html
          path: output/sonar-professional-report.html
          retention-days: ${{ inputs.artifact-retention-days }}
